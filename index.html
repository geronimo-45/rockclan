<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>

  <!-- ✅ React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>

  <!-- ✅ PropTypes -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" defer></script>

  <!-- ✅ 안정 버전 Recharts -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js" defer></script>

  <!-- ✅ Chart.js (ELO 히스토리 팝업용) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- favicon 404 억제 -->
  <link rel="icon" type="image/x-icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root {
      --bg1:#0b0710; --bg2:#14050a; --accent:#ff6a00; --muted:#a7a0a8; --card:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03);cursor:pointer}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters>*{flex:1 1 160px}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .match-header{font-weight:700;margin-bottom:6px;cursor:pointer;color:#ffb347}
    .match-item{color:#ddd;font-size:14px;margin:4px 0;padding-left:8px}
    .hidden{display:none;}

    /* 🔹 모달 스타일 */
    .modal {
      display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%;
      background-color:rgba(0,0,0,0.6); padding-top:60px;
    }
    .modal-content {
      background-color:#1a1a22; margin:auto; padding:20px; border-radius:12px; width:70%; max-height:80%;
      overflow-y:auto; color:#eee; box-shadow:0 0 20px rgba(0,0,0,0.6);
    }
    .close {
      float:right; font-size:28px; cursor:pointer; color:#aaa;
    }
    .close:hover { color:#fff; }
  </style>
</head>

<body>
  <!-- 기존 body 내용 동일 -->
  <!-- ... (생략: 당신이 준 원본 코드 전체 유지) ... -->

  <!-- 🔹 플레이어 히스토리 모달 추가 -->
  <div id="playerModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <h2 id="modalPlayerName" style="color:var(--accent);margin-top:0;"></h2>
      <div id="modalPlayerInfo" style="font-size:14px;margin-bottom:12px;color:#ccc;"></div>
      <canvas id="modalEloChart" width="600" height="250" style="background:#111;border-radius:8px;margin-bottom:16px;"></canvas>
      <div id="modalMatchHistory" style="font-size:14px;color:#ddd;"></div>
    </div>
  </div>

  <!-- ✅ 기존 script 유지 -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ⚙️ 기존 코드 동일 — 중략 (start(), renderAll 등 유지) */

    // renderAll 내부 마지막 부분 아래에 추가
    const originalRenderAll = renderAll;
    renderAll = function(data){
      originalRenderAll(data);
      // 🔹 테이블 행 클릭 이벤트 등록
      setTimeout(()=>{
        document.querySelectorAll('#players-table tbody tr').forEach(tr=>{
          tr.addEventListener('click',()=>{
            const playerId = tr.children[1].textContent.trim();
            showPlayerModal(playerId, data);
          });
        });
      },300);
    }

    // 🔹 플레이어 히스토리 모달 함수
    function showPlayerModal(playerId, data){
      const modal=document.getElementById('playerModal');
      const player=data.players.find(p=>p.id===playerId);
      if(!player) return;

      const statMap=new Map();
      const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
      const getTierIndex=t=>Math.max(0,TierOrder.indexOf(t||'Silver'));
      const calc=(A,B,res,isTeam)=>{
        const K=isTeam?8:12;
        const effA=A.elo+getTierIndex(A.tier)*40;
        const effB=B.elo+getTierIndex(B.tier)*40;
        const expectedA=1/(1+Math.pow(10,(effB-effA)/400));
        const delta=K*(res-expectedA);
        A.elo+=delta; B.elo-=delta;
      };

      const ensure=(id)=>{
        if(statMap.has(id))return statMap.get(id);
        const meta=data.players.find(p=>p.id===id)||{};
        const o={id,tier:meta.tier||'Silver',race:meta.race||'Protoss',elo:1000,history:[1000]};
        statMap.set(id,o);return o;
      };

      const matches=(data.matches||[]).filter(m=>m.map!=="Match");
      matches.sort((a,b)=>String(a.date).localeCompare(String(b.date)));

      for(const m of matches){
        if(m.player1&&m.player2){
          const p1=ensure(m.player1), p2=ensure(m.player2);
          const win=(m.winner===m.player1)?1:(m.winner===m.player2)?0:null;
          if(win!==null){ calc(p1,p2,win,false);
            p1.history.push(Math.round(p1.elo)); p2.history.push(Math.round(p2.elo));
          }
        }
        if(Array.isArray(m.team1)&&Array.isArray(m.team2)){
          const T1=m.team1.map(ensure), T2=m.team2.map(ensure);
          const winners=Array.isArray(m.winner)?m.winner:[];
          const win1=winners.some(x=>m.team1.includes(x))?1:0;
          const avg1=T1.reduce((a,b)=>a+b.elo,0)/T1.length;
          const avg2=T2.reduce((a,b)=>a+b.elo,0)/T2.length;
          const dA={elo:avg1,tier:'Silver'},dB={elo:avg2,tier:'Silver'};
          calc(dA,dB,win1,true);
          const diffA=dA.elo-avg1,diffB=dB.elo-avg2;
          T1.forEach(p=>{p.elo+=diffA;p.history.push(Math.round(p.elo));});
          T2.forEach(p=>{p.elo+=diffB;p.history.push(Math.round(p.elo));});
        }
      }

      const target=statMap.get(playerId);
      if(!target){alert("경기 기록이 없습니다.");return;}

      // 🔹 모달 내용 구성
      document.getElementById('modalPlayerName').textContent=player.id;
      document.getElementById('modalPlayerInfo').innerHTML=
        `<b>Race:</b> ${player.race} | <b>Tier:</b> ${player.tier} | <b>현재 ELO:</b> ${Math.round(target.elo)} (${target.history.length-1}경기)`;

      // 🔹 ELO 히스토리 차트
      const ctx=document.getElementById('modalEloChart').getContext('2d');
      if(window.modalChart) window.modalChart.destroy();
      window.modalChart=new Chart(ctx,{
        type:'line',
        data:{
          labels:target.history.map((_,i)=>i),
          datasets:[{
            label:'ELO',
            data:target.history,
            borderColor:'#ff6a00',
            borderWidth:2,
            fill:false,
            tension:0.3
          }]
        },
        options:{
          scales:{
            y:{beginAtZero:false,ticks:{color:'#ccc'},grid:{color:'rgba(255,255,255,0.1)'}},
            x:{ticks:{color:'#ccc'},grid:{color:'rgba(255,255,255,0.1)'}}
          },
          plugins:{legend:{display:false}}
        }
      });

      // 🔹 경기 히스토리 목록
      const playerMatches=matches.filter(m=>
        (m.player1===playerId||m.player2===playerId||
         (Array.isArray(m.team1)&&m.team1.includes(playerId))||
         (Array.isArray(m.team2)&&m.team2.includes(playerId)))
      );
      const html=playerMatches.map(m=>{
        const isWin=(m.winner===playerId)||(Array.isArray(m.winner)&&m.winner.includes(playerId));
        return `<div style="margin:4px 0;">${m.date} | ${m.map} | <b style="color:${isWin?'#4ade80':'#f87171'};">${isWin?'승':'패'}</b> ${m.score?`| ${m.score}`:''}</div>`;
      }).join('');
      document.getElementById('modalMatchHistory').innerHTML=html||'경기 기록 없음';

      // 모달 표시 / 닫기
      modal.style.display='block';
      document.getElementById('closeModal').onclick=()=>modal.style.display='none';
      window.onclick=(e)=>{ if(e.target===modal) modal.style.display='none'; };
    }
  });
  </script>
</body>
</html>
