<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>

  <!-- âœ… React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>

  <!-- âœ… PropTypes (ì „ì—­ ì£¼ì…: Rechartsë³´ë‹¤ ë°˜ë“œì‹œ ë¨¼ì € ë¡œë“œ) -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" defer></script>

  <!-- âœ… ì•ˆì • ë²„ì „ Recharts (ë²„ê·¸ íšŒí”¼) -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js" defer></script>

  <!-- favicon 404 ì–µì œ -->
  <link rel="icon" type="image/x-icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root {
      --bg1:#0b0710; --bg2:#14050a; --accent:#ff6a00; --muted:#a7a0a8; --card:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters>*{flex:1 1 160px}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .match-header{font-weight:700;margin-bottom:6px;cursor:pointer;color:#ffb347}
    .match-item{color:#ddd;font-size:14px;margin:4px 0;padding-left:8px}
    .hidden{display:none;}
  </style>
</head>

<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">í´ëœì› ë­í‚¹ â€¢ ê¸°ë¡ì‹¤ â€¢ ELO ì‹œìŠ¤í…œ ì„¤ëª… â€¢ ë³€ë™ ê·¸ë˜í”„</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">í´ëœì› ë­í‚¹</button>
    <button class="tab" data-tab="records">ê¸°ë¡ì‹¤</button>
    <button class="tab" data-tab="elo-info">ELO ì‹œìŠ¤í…œ ì„¤ëª…</button>
    <button class="tab" data-tab="chart">ELO ë³€ë™ ê·¸ë˜í”„</button>
  </nav>
<!-- ğŸ”¹ í”Œë ˆì´ì–´ íˆìŠ¤í† ë¦¬ íŒì—… -->
<div id="playerModal" class="modal" style="position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);padding-top:60px;display:none;">
  <div class="modal-content" style="background:#1a1a22;margin:auto;padding:20px;border-radius:12px;width:85%;max-height:80%;overflow-y:auto;color:#eee;box-shadow:0 0 20px rgba(0,0,0,.6)">
    <span id="closeModal" class="close" style="float:right;font-size:28px;cursor:pointer;color:#aaa">&times;</span>
    <h2 id="modalPlayerName" style="color:#ff6a00;margin-top:0;"></h2>
    <div id="modalPlayerInfo" style="font-size:14px;margin-bottom:12px;color:#ccc;"></div>
    <canvas id="modalEloChart" width="600" height="250" style="background:#111;border-radius:8px;margin-bottom:16px;"></canvas>
    <div id="modalMatchHistory" style="font-size:14px;color:#ddd;"></div>
  </div>
</div>

  <main>
    <!-- ë­í‚¹ -->
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">í´ëœì› ë­í‚¹</h2>
        <div class="filters">
          <input id="search" placeholder="ID ê²€ìƒ‰" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">ì¢…ì¡± ì „ì²´</option>
            <option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">í‹°ì–´ ì „ì²´</option>
            <option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">í˜„ì¬ ELO ìˆœì„œ ê¸°ì¤€</div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>ì¢…ì¡±</th><th>í‹°ì–´</th><th>ELO</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ê¸°ë¡ì‹¤ -->
    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ê¸°ë¡ì‹¤</h2>
        <div id="records-months" class="filters" style="margin-bottom:10px;"></div>
        <div id="match-list"></div>
      </div>
    </section>

    <!-- ELO ì„¤ëª… (ì›ë³¸ ìŠ¤íƒ€ì¼ ìœ ì§€) -->
<section id="elo-info">
  <div class="card">
    <h2 style="margin:6px 0;color:var(--accent)">ELO ì‹œìŠ¤í…œ ì„¤ëª…</h2>

    <p style="line-height:1.6;color:#ddd">
      RockClanì˜ ELO ì‹œìŠ¤í…œì€ ë‹¨ìˆœí•œ ì ìˆ˜ ì°¨ì´ë¿ ì•„ë‹ˆë¼ <b>í‹°ì–´(Tier) ë³´ì •</b>ì„ í¬í•¨í•˜ì—¬ ì‹¤ì œ ì‹¤ë ¥ ê²©ì°¨ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.<br>
      ëª¨ë“  ê³„ì‚°ì€ ê¸°ë¡ì‹¤(match) ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìˆ˜í–‰ë©ë‹ˆë‹¤.
    </p>

    <ul style="line-height:1.8;color:#ccc;margin-left:12px">
      <li><b>ì´ˆê¸° ELO</b>: ì‹ ê·œ í”Œë ˆì´ì–´ëŠ” 1000ì ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</li>
      <li><b>K ê°’</b>:
        <ul>
          <li>ê°œì¸ì „(1:1): <b>K = 12</b></li>
          <li>íŒ€ì „(2:2, 3:3, 4:4 ë“±): <b>K = 8</b></li>
        </ul>
      </li>
      <li><b>í‹°ì–´ ì¸ë±ìŠ¤ ë³´ì •</b>:
        <ul>
          <li>Stone=0, Bronze=1, Silver=2, Gold=3, Diamond=4, Legend=5</li>
          <li>ì‹¤ì œ ê³„ì‚°ì€ <code>EffectiveElo = ELO + (TierIndex Ã— 40)</code> ìœ¼ë¡œ ìˆ˜í–‰ë©ë‹ˆë‹¤.</li>
        </ul>
      </li>
      <li>ì˜ˆìƒ ìŠ¹ë¥ ì€ ë‘ í”Œë ˆì´ì–´ì˜ <b>EffectiveElo</b> ì°¨ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
      <li>ê²½ê¸° ê²°ê³¼ëŠ” ì˜ˆìƒ ìŠ¹ë¥  ëŒ€ë¹„ ì‹¤ì œ ìŠ¹íŒ¨ ì°¨ì´ë§Œí¼ ELOê°€ ë³€ë™í•©ë‹ˆë‹¤.</li>
    </ul>

    <h3 style="margin-top:16px;color:var(--accent)">ğŸ“ˆ ELO ê³„ì‚° ì˜ˆì‹œ</h3>
    <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:14px;color:#ddd">
      <thead>
        <tr style="background:rgba(255,255,255,0.05)">
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">ìƒí™©</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">ELO ì°¨ì´</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">í‹°ì–´ ì°¨ì´</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">ì˜ˆìƒ ìŠ¹ë¥ </th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">ìŠ¹ë¦¬ ì‹œ</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">íŒ¨ë°° ì‹œ</th>
        </tr>
      </thead>
      <tbody>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">1:1 (ë™í‹°ì–´, ë™ì¼ ELO)</td><td>0</td><td>0</td><td>50%</td><td>+6</td><td>âˆ’6</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">Silver(2) vs Gold(3)</td><td>0</td><td>+1</td><td>46%</td><td>+7</td><td>âˆ’5</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">Gold(3) vs Silver(2)</td><td>0</td><td>âˆ’1</td><td>54%</td><td>+5</td><td>âˆ’7</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">íŒ€ì „ (í‰ê·  ë™í‹°ì–´)</td><td>0</td><td>0</td><td>50%</td><td>+4</td><td>âˆ’4</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">íŒ€ì „ (ìƒëŒ€íŒ€ í‰ê·  Diamondâ†‘)</td><td>âˆ’150</td><td>+2</td><td>32%</td><td>+6</td><td>âˆ’3</td></tr>
      </tbody>
    </table>

    <p style="margin-top:10px;color:#999">
      â€» ELO ê³„ì‚°ì‹: <code>NewElo = OldElo + K Ã— (Actual âˆ’ Expected)</code><br>
      â€» í‹°ì–´ ì¸ë±ìŠ¤ ë³´ì •ìœ¼ë¡œ ì¸í•´ ìƒìœ„ í‹°ì–´ë¥¼ ì´ê¸¸ ê²½ìš° ìƒìŠ¹í­ì´ ë” ì»¤ì§‘ë‹ˆë‹¤.
    </p>

    <!-- ğŸ”¹ ì‹œë®¬ë ˆì´í„° -->
    <h3 style="margin-top:30px;color:var(--accent)">ğŸ§® ELO ê³„ì‚° ì‹œë®¬ë ˆì´í„°</h3>
    <div style="color:#ddd;font-size:14px;line-height:1.8;">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
        <label>í”Œë ˆì´ì–´ A ELO <input id="eloA" type="number" value="1000" style="width:80px;margin-left:6px;padding:4px;background:#111;border:1px solid #333;color:#fff;"></label>
        <label>í‹°ì–´
          <select id="tierA" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option>Stone</option><option>Bronze</option><option selected>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </label>
        <span style="margin:0 12px;">vs</span>
        <label>í”Œë ˆì´ì–´ B ELO <input id="eloB" type="number" value="1000" style="width:80px;margin-left:6px;padding:4px;background:#111;border:1px solid #333;color:#fff;"></label>
        <label>í‹°ì–´
          <select id="tierB" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option>Stone</option><option>Bronze</option><option>Silver</option><option selected>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </label>
        <label style="margin-left:16px;">ê²½ê¸° íƒ€ì…
          <select id="gameType" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option value="1v1" selected>1:1</option>
            <option value="team">íŒ€ì „</option>
          </select>
        </label>
        <button id="calcBtn" style="margin-left:12px;padding:6px 12px;border:none;border-radius:6px;background:var(--accent);color:#111;cursor:pointer;">ê³„ì‚°</button>
      </div>

      <div id="simResult" style="margin-top:10px;padding:10px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.03);">
        ê³„ì‚° ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
      </div>
    </div>

    <script>
      document.getElementById("calcBtn").addEventListener("click",()=>{
        const getTierIndex=t=>["Stone","Bronze","Silver","Gold","Diamond","Legend"].indexOf(t);
        const eloA=parseFloat(document.getElementById("eloA").value||1000);
        const eloB=parseFloat(document.getElementById("eloB").value||1000);
        const tierA=document.getElementById("tierA").value;
        const tierB=document.getElementById("tierB").value;
        const gameType=document.getElementById("gameType").value;
        const K=(gameType==="team")?8:12;

        const effA=eloA+getTierIndex(tierA)*40;
        const effB=eloB+getTierIndex(tierB)*40;
        const expectedA=1/(1+Math.pow(10,(effB-effA)/400));
        const deltaWin = K*(1-expectedA);
        const deltaLose = -K*(expectedA);
        const winPct=(expectedA*100).toFixed(1);

        document.getElementById("simResult").innerHTML=`
          <div><b>ì˜ˆìƒ ìŠ¹ë¥ </b>: A ${winPct}% / B ${(100-expectedA*100).toFixed(1)}%</div>
          <div><b>Kê°’</b>: ${K}</div>
          <div><b>A ìŠ¹ë¦¬ ì‹œ</b>: A +${deltaWin.toFixed(2)} / B ${deltaLose.toFixed(2)}</div>
          <div><b>B ìŠ¹ë¦¬ ì‹œ</b>: A ${(-deltaWin).toFixed(2)} / B +${(-deltaLose).toFixed(2)}</div>
        `;
      });
    </script>

  </div>
</section>


    <!-- ê·¸ë˜í”„ -->
    <section id="chart">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO ë³€ë™ ê·¸ë˜í”„</h2>
        <div class="muted">ì—¬ëŸ¬ ëª…ì„ ì„ íƒí•´ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•©ë‹ˆë‹¤. (Xì¶•: MM/DD, Yì¶•: 800~1200)</div>
        <div id="elo-chart-container" style="margin-top:16px;"></div>
      </div>
    </section>
  </main>

  <!-- âœ… Chart.js ë¡œë“œ (defer ì¶”ê°€) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

<!-- âœ… ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ -->
<script>
(function(){
  // --- íƒ­ ì „í™˜ ---
  document.querySelectorAll('nav .tab').forEach(btn=>{
    btn.addEventListener('click', e=>{
      document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
    });
  });

  // --- ì•ˆì „ ë¡œë” (ê¸°ì¡´ ìœ ì§€) ---
  const safe = async (url) => {
    try {
      const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch (e) { console.error('âŒ JSON íŒŒì‹± ì‹¤íŒ¨:', url, txt.slice(0,200)); return {players:[], matches:[]}; }
    } catch (e) {
      console.error('âŒ ë¡œë“œ ì‹¤íŒ¨:', url, e);
      return {players:[], matches:[]};
    }
  };

  const basePath = location.pathname.replace(/[^\/]*$/, '');
  const path = (name) => basePath + name;

  const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
  const getTierIndex = t => Math.max(0, TierOrder.indexOf(t||'Silver'));
  const toMMDD = d => d ? d.split('-').slice(1).join('/') : '';

  const $search = document.getElementById('search');
  const $race   = document.getElementById('raceFilter');
  const $tier   = document.getElementById('tierFilter');

start();

async function start() {
  // ê¸°ë³¸ ë°ì´í„° ë¡œë“œ
  const base = await safe(path('data.json'));

  // ğŸ”¹ ì¶”ê°€ ë‹¬ ë°ì´í„° ëª©ë¡ (í•„ìš”ì‹œ ì—¬ê¸°ì—ë§Œ ì¶”ê°€í•˜ë©´ ë¨)
  const months = ['oct', 'nov', 'dec']; // ì˜ˆ: ['oct', 'nov', 'dec', 'jan'] í˜•íƒœë¡œ í™•ì¥ ê°€ëŠ¥

  // ğŸ”¹ ê° ë‹¬ì˜ JSON ìë™ ë³‘í•©
  for (const m of months) {
    try {
      const data = await safe(path(`data_${m}.json`));
      base.matches = (base.matches || []).concat(data.matches || []);
      const seen = new Set((base.players || []).map(p => p.id));
      (data.players || []).forEach(p => {
        if (!seen.has(p.id)) base.players.push(p);
      });
    } catch (err) {
      console.warn(`âš ï¸ data_${m}.json ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`, err);
    }
  }

  // ëª¨ë“  ë°ì´í„° ë³‘í•© í›„ ë Œë”
  renderAll(base);
}


  function renderAll(data){
    const playersMeta = new Map((data.players||[]).map(p=>[p.id,p]));
    const stat = new Map();
    const eloByDate = {};

    const ensure = (id)=>{
      if(stat.has(id)) return stat.get(id);
      const m=playersMeta.get(id)||{};
      const o={ id, elo:1000, tier:m.tier||'Silver', race:m.race||'Protoss', win:0, loss:0, played:0 };
      stat.set(id,o); return o;
    };

    const calc = (A,B,res,isTeam)=>{
      const K = isTeam? 8 : 12;
      const effA = A.elo + getTierIndex(A.tier)*40;
      const effB = B.elo + getTierIndex(B.tier)*40;
      const expectedA = 1/(1+Math.pow(10,(effB-effA)/400));
      const delta = K*(res-expectedA);
      A.elo += delta; B.elo -= delta;
    };

    const matches = (data.matches||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));

    for(const m of matches){
      if(!m.map || m.map==='Match') continue;
      const d = toMMDD(m.date);

      if(m.player1 && m.player2){
        const p1=ensure(m.player1), p2=ensure(m.player2);
        if(m.winner===m.player1){ calc(p1,p2,1,false); p1.win++; p2.loss++; }
        else if(m.winner===m.player2){ calc(p1,p2,0,false); p2.win++; p1.loss++; }
        p1.played++; p2.played++;
        (eloByDate[p1.id]??={})[d]=Math.round(p1.elo);
        (eloByDate[p2.id]??={})[d]=Math.round(p2.elo);
      }

      if(Array.isArray(m.team1) && Array.isArray(m.team2)){
        const T1=m.team1.map(ensure), T2=m.team2.map(ensure);
        const winners = Array.isArray(m.winner)? m.winner : [];
        const win1 = winners.some(x=>m.team1.includes(x)) ? 1 : 0;

        const avg1=T1.reduce((a,b)=>a+b.elo,0)/T1.length;
        const avg2=T2.reduce((a,b)=>a+b.elo,0)/T2.length;
        const dA={elo:avg1,tier:'Silver'}, dB={elo:avg2,tier:'Silver'};
        calc(dA,dB,win1,true);
        const diffA=dA.elo-avg1, diffB=dB.elo-avg2;

        T1.forEach(p=>{ p.elo+=diffA; p.played++; win1?p.win++:p.loss++; (eloByDate[p.id]??={})[d]=Math.round(p.elo); });
        T2.forEach(p=>{ p.elo+=diffB; p.played++; !win1?p.win++:p.loss++; (eloByDate[p.id]??={})[d]=Math.round(p.elo); });
      }
    }

// --- ë­í‚¹ í‘œì‹œ (ELO ë‚´ë¦¼ì°¨ìˆœ) + í•„í„° ---
const tbody = document.querySelector('#players-table tbody');

// ğŸ”§ const â†’ let ë¡œ ë³€ê²½í•˜ê³ , ìˆ¨ê¹€ í•„í„° ì ìš©
let allRows = [...stat.values()].sort((a,b)=>b.elo-a.elo);

// ìˆ¨ê¸¸ ID ëª©ë¡ (íƒˆí‡´ íšŒì› ëª©ë¡)
const HIDE = new Set(['Wonder', 'ceta']);

// íƒˆí‡´ íšŒì› ìˆ¨ê¸°ê¸°
allRows = allRows.filter(p => !HIDE.has(p.id));

    function applyFilters(){
      const q = ($search.value||'').trim().toLowerCase();
      const r = $race.value||'';
      const t = $tier.value||'';

      const filtered = allRows.filter(p=>{
        if(q && !p.id.toLowerCase().includes(q)) return false;
        if(r && p.race!==r) return false;
        if(t && p.tier!==t) return false;
        return true;
      });

      tbody.innerHTML = filtered.map((p,i)=>{
        const wr = p.played? ((p.win/p.played)*100).toFixed(1) : '0.0';
        return `<tr>
          <td>${i+1}</td><td>${p.id}</td><td>${p.race}</td>
          <td class="tier-${p.tier}">${p.tier}</td>
          <td>${Math.round(p.elo)}</td><td>${p.win}</td><td>${p.loss}</td><td>${wr}%</td>
        </tr>`;
      }).join('');
    }
    ['input','change'].forEach(ev=>{
      $search.addEventListener(ev,applyFilters);
      $race.addEventListener(ev,applyFilters);
      $tier.addEventListener(ev,applyFilters);
    });
    applyFilters();

// --- ê¸°ë¡ì‹¤ (ì›”ë³„ íƒ­) ---
const list = document.getElementById('match-list');
const tabsWrap = document.getElementById('records-months');

// 1) ì›” í‚¤/ë¼ë²¨ í•¨ìˆ˜
const getMonthKey = (iso) => {
  // iso: YYYY-MM-DD
  if(!iso || !iso.includes('-')) return 'unknown';
  const [y,m] = iso.split('-');
  return `${y}-${m}`; // e.g. 2025-09
};
const getMonthLabel = (key) => {
  // key: YYYY-MM
  const [y,m] = key.split('-');
  const yy = String(y).slice(2);             // '25'
  const mm = String(parseInt(m,10));         // '9' (ì•ì˜ 0 ì œê±°)
  return `${yy}ë…„ ${mm}ì›”`;
};

// 2) ì›” ëª©ë¡ ë§Œë“¤ê¸° (ë°ì´í„° ê¸°ë°˜)
const byMonth = new Map();
for (const m of matches) {
  const key = getMonthKey(m.date);
  if (!byMonth.has(key)) byMonth.set(key, []);
  byMonth.get(key).push(m);
}

// 3) ì›” ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ: 2025-09, 10, 11, 12 â€¦)
const monthsSorted = [...byMonth.keys()].sort((a,b)=> a.localeCompare(b));

// 4) íƒ­ ë²„íŠ¼ ë Œë”
tabsWrap.innerHTML = monthsSorted.map((key,i)=>`
  <button class="month-tab${i===monthsSorted.length-1?' active':''}"
    data-month="${key}"
    style="background:#1a1a22;border:1px solid #232532;color:#ddd;padding:8px 12px;border-radius:10px;cursor:pointer;">
    ${getMonthLabel(key)}
  </button>
`).join(' ');

// 5) ì›”ë³„ ë Œë” í•¨ìˆ˜ (ë‚ ì§œë³„ ì ‘ê¸°/í¼ì¹˜ê¸° í¬í•¨)
function renderMonth(key){
  const data = (byMonth.get(key)||[]).slice().sort((a,b)=> String(a.date).localeCompare(String(b.date)));
  list.innerHTML = ''; // reset

  let curDate=null, box=null, mCount=0;
  const flushHeader = ()=>{ if(box && mCount>0){ box.querySelector('.match-header').textContent += ` (Match ${mCount}ê²Œì„)`; } };

  for(const m of data){
    if(m.date !== curDate){
      flushHeader();
      curDate = m.date; mCount = 0;

      box = document.createElement('div');
      box.className = 'match';

      const hdr = document.createElement('div');
      hdr.className = 'match-header';
      hdr.textContent = `${curDate}`;

      const inner = document.createElement('div');
      inner.className = 'match-inner hidden';
      hdr.addEventListener('click',()=> inner.classList.toggle('hidden'));

      box.appendChild(hdr);
      box.appendChild(inner);
      list.appendChild(box);
    }

    const wrap = box.querySelector('.match-inner');

    if(m.map === 'Match'){
      mCount++;
      const line = document.createElement('div');
      line.className = 'match-item';
      line.style.color = '#a8e0a8';
      const win = Array.isArray(m.winner)? m.winner.join(', ') : (m.winner||'-');
      line.textContent = `[Match] ìŠ¹ì: ${win}${m.score?` | ìŠ¤ì½”ì–´: ${m.score}`:''}`;
      wrap.appendChild(line);
      continue;
    }

    if(m.player1 && m.player2){
      const l = document.createElement('div'); l.className='match-item';
      l.textContent = `${m.map||'-'} â€” ${m.player1} vs ${m.player2} | ìŠ¹ì: ${m.winner||'-'}${m.score?` | ${m.score}`:''}`;
      wrap.appendChild(l);
    }

    if(Array.isArray(m.team1) && Array.isArray(m.team2)){
      const l = document.createElement('div'); l.className='match-item';
      const win = Array.isArray(m.winner)? m.winner.join(', ') : (m.winner||'-');
      l.textContent = `${m.map||'-'} â€” [${m.team1.join(', ')}] vs [${m.team2.join(', ')}] | ìŠ¹ì: ${win}${m.score?` | ${m.score}`:''}`;
      wrap.appendChild(l);
    }
  }
  flushHeader();
}

// 6) ì´ˆê¸° í‘œì‹œ: ìµœì‹  ì›”(ë§ˆì§€ë§‰ íƒ­) ìë™ ì„ íƒ
if (monthsSorted.length){
  renderMonth(monthsSorted[monthsSorted.length-1]);
}

// 7) íƒ­ í´ë¦­ ì´ë²¤íŠ¸
tabsWrap.addEventListener('click', (e)=>{
  const btn = e.target.closest('.month-tab');
  if(!btn) return;
  // active í† ê¸€
  tabsWrap.querySelectorAll('.month-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  // ë Œë”
  const key = btn.dataset.month;
  renderMonth(key);
});


    // --- ê·¸ë˜í”„ ---
    renderChart(eloByDate);
  }

  function renderChart(eloByDate){
    const container=document.getElementById('elo-chart-container');
    
  // ğŸ”¹ ìˆ¨ê¸¸ ID ëª©ë¡ ì •ì˜
  const HIDE = new Set(['Wonder', 'ceta']);

  container.innerHTML = `
    <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
      <div>
        <div style="font-size:13px;color:#aaa;margin-bottom:6px">ë¹„êµí•  í”Œë ˆì´ì–´ ì„ íƒ (Ctrl/âŒ˜ ë‹¤ì¤‘ ì„ íƒ)</div>
        <select id="eloPlayerSelect" multiple size="10"
          style="min-width:220px;height:200px;padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
          ${Object.keys(eloByDate)
              .filter(id => !HIDE.has(id))   // ğŸ”¹ ìˆ¨ê¸¸ ID ì œì™¸
              .sort()
              .map(id => `<option value="${id}">${id}</option>`)
              .join('')}
          </select>
        </div>
        <div id="eloChartArea" style="flex:1;min-width:320px;width:100%;height:460px"></div>
      </div>
    `;

    const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};
    const area = document.getElementById('eloChartArea');
    if(!LineChart){ area.innerHTML=`<div class="muted">Rechartsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>`; return; }

    const palette=["#ff6a00","#4ade80","#60a5fa","#f472b6","#facc15","#38bdf8","#a78bfa","#fb923c","#22d3ee","#94a3b8"];

    function draw(sel){
      if(!sel.length){ area.innerHTML=`<div class="muted">ì™¼ìª½ì—ì„œ 1ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.</div>`; return; }
      const dates=[...new Set(sel.flatMap(id=>Object.keys(eloByDate[id]||{})))].sort((a,b)=>{
        const [am,ad]=a.split('/').map(Number), [bm,bd]=b.split('/').map(Number);
        return am===bm? ad-bd : am-bm;
      });
      const rows=dates.map(d=>{ const r={date:d}; sel.forEach(id=>r[id]=eloByDate[id]?.[d]??null); return r; });

      ReactDOM.render(
        React.createElement(
          ResponsiveContainer,{width:"100%",height:460},
          React.createElement(LineChart,{data:rows,margin:{top:20,right:30,left:0,bottom:0}},
            React.createElement(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.12)"}),
            React.createElement(XAxis,{dataKey:"date",stroke:"#aaa",tick:{fontSize:12}}),
            React.createElement(YAxis,{stroke:"#aaa",domain:[800,1200],tick:{fontSize:12}}),
            React.createElement(Tooltip,{formatter:v=>Math.round(v),contentStyle:{backgroundColor:"#1a1a22",border:"1px solid #333"}}),
            React.createElement(Legend,null),
            ...sel.map((id,i)=>React.createElement(Line,{
              key:id, type:"monotone", dataKey:id, name:id,
              stroke:palette[i%palette.length], dot:false, strokeWidth:2, isAnimationActive:false
            }))
          )
        ), area
      );
    }

    document.getElementById('eloPlayerSelect').addEventListener('change', e=>{
      const sel=[...e.target.selectedOptions].map(o=>o.value);
      draw(sel);
    });
  }

  // --- íŒì—… ë¡œì§ ---
  const tbody = document.querySelector('#players-table tbody');
  if(!tbody) return;

  tbody.addEventListener('click', async e=>{
    const tr = e.target.closest('tr');
    if(!tr) return;
    const playerId = tr.children[1]?.textContent.trim();
    if(!playerId) return;
    await showPlayerModal(playerId);
  });

  async function showPlayerModal(playerId){
    try {
      // 1) ê¸°ë³¸ + ì›”ë³„ ë°ì´í„° ë³‘í•© (ë©”ì¸ê³¼ ë™ì¼í•œ ë°©ì‹ìœ¼ë¡œ í†µì¼)
      const base = await safe(path('data.json'));

      // âœ… í˜„ì¬ í¬í•¨ ë‹¬ (í•„ìš” ì‹œ ì—¬ê¸°ë§Œ ì¶”ê°€: 'dec','jan' â€¦)
      const months = ['oct','nov','dec'];

      for (const m of months) {
        const add = await safe(path(`data_${m}.json`));
        base.matches = (base.matches || []).concat(add.matches || []);
        const seen = new Set((base.players || []).map(p => p.id));
        (add.players || []).forEach(p => { if (!seen.has(p.id)) base.players.push(p); });
      }

      const player = base.players.find(p=>p.id===playerId);
      if(!player){ alert('í”Œë ˆì´ì–´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }

      const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
      const getTierIndex=t=>Math.max(0,TierOrder.indexOf(t||'Silver'));
      const calc=(A,B,res,isTeam)=>{
        const K=isTeam?8:12;
        const effA=A.elo+getTierIndex(A.tier)*40;
        const effB=B.elo+getTierIndex(B.tier)*40;
        const expectedA=1/(1+Math.pow(10,(effB-effA)/400));
        const delta=K*(res-expectedA);
        A.elo+=delta;B.elo-=delta;
      };

      const stat=new Map();
      const ensure=(id)=>{
        if(stat.has(id))return stat.get(id);
        const meta=(base.players||[]).find(p=>p.id===id)||{};
        const o={id,tier:meta.tier||'Silver',race:meta.race||'Protoss',elo:1000,history:[1000]};
        stat.set(id,o);return o;
      };

      const matches=(base.matches||[])
        .filter(m=>m.map!=="Match")
        .slice()
        .sort((a,b)=>String(a.date).localeCompare(String(b.date)));

      const playerLog=[];

      for(const m of matches){
        if(m.player1 && m.player2){
          const p1=ensure(m.player1), p2=ensure(m.player2);
          const res=(m.winner===m.player1)?1:(m.winner===m.player2)?0:null;
          let involved=false, eloBefore=0, opponentText='';
          if(m.player1===playerId){involved=true; eloBefore=p1.elo; opponentText=m.player2;}
          else if(m.player2===playerId){involved=true; eloBefore=p2.elo; opponentText=m.player1;}
          if(res!==null){
            calc(p1,p2,res,false);
            p1.history.push(Math.round(p1.elo));
            p2.history.push(Math.round(p2.elo));
          }
          if(involved){
            const after=(m.player1===playerId)?p1.elo:p2.elo;
            const isWin=(m.winner===playerId);
            playerLog.push({date:m.date,map:m.map||'-',opponentText,isWin,eloAfter:Math.round(after),delta:Math.round(after-eloBefore)});
          }
        }

        if(Array.isArray(m.team1)&&Array.isArray(m.team2)){
          const T1=m.team1.map(ensure), T2=m.team2.map(ensure);
          const winners=Array.isArray(m.winner)?m.winner:[];
          const win1=winners.some(x=>m.team1.includes(x))?1:0;
          const inTeam1=m.team1.includes(playerId), inTeam2=m.team2.includes(playerId);
          const involved=inTeam1||inTeam2;
          let eloBefore=0, opponentText='';
          if(involved){
            const me=inTeam1?T1.find(p=>p.id===playerId):T2.find(p=>p.id===playerId);
            eloBefore=me.elo;
            opponentText=(inTeam1?m.team2:m.team1).join(', ');
          }
          const avg1=T1.reduce((a,b)=>a+b.elo,0)/T1.length;
          const avg2=T2.reduce((a,b)=>a+b.elo,0)/T2.length;
          const dA={elo:avg1,tier:'Silver'}, dB={elo:avg2,tier:'Silver'};
          calc(dA,dB,win1,true);
          const diffA=dA.elo-avg1, diffB=dB.elo-avg2;
          T1.forEach(p=>{p.elo+=diffA;p.history.push(Math.round(p.elo));});
          T2.forEach(p=>{p.elo+=diffB;p.history.push(Math.round(p.elo));});
          if(involved){
            const meAfter=(inTeam1?T1:T2).find(p=>p.id===playerId).elo;
            const isWin=inTeam1?!!win1:!win1;
            playerLog.push({
              date:m.date,
              map:m.map || '-',
              opponentText,
              isWin,
              eloAfter:Math.round(meAfter),
              delta:Math.round(meAfter - eloBefore)
            });
          }
        }
      }

      const target=stat.get(playerId);
      if(!target){ alert('ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }

      // --- íŒì—… í—¤ë” ì •ë³´ ---
      document.getElementById('modalPlayerName').textContent=player.id;
      document.getElementById('modalPlayerInfo').innerHTML=
        `<b>Race:</b> ${player.race} | <b>Tier:</b> ${player.tier} | <b>í˜„ì¬ ELO:</b> ${Math.round(target.elo)} (${target.history.length-1}ê²½ê¸°)`;

      // --- ì„¸ë¶€ ì „ì  ê³„ì‚° ---
      let soloWin=0, soloLoss=0, teamWin=0, teamLoss=0;
      let scWin=0, scLoss=0, htWin=0, htLoss=0;
      let proWin=0, proLoss=0; // âœ… í”„ë¡œë¦¬ê·¸ ì „ì 

      for (const m of base.matches || []) {
        const isSolo = !!(m.player1 && m.player2);
        const isTeam = Array.isArray(m.team1) && Array.isArray(m.team2);
        const isSC = (m.map||'').includes('ìƒì»¨');
        const isHT = (m.map||'').includes('í—Œí„°');

        // âœ… í”„ë¡œë¦¬ê·¸ ("Match" í‘œì‹œ)
        if (m.map === "Match" && Array.isArray(m.team1) && Array.isArray(m.team2)) {
          const inT1 = m.team1.includes(playerId);
          const inT2 = m.team2.includes(playerId);
          if (!inT1 && !inT2) continue;

          const winners = Array.isArray(m.winner) ? m.winner : [];
          const win1 = winners.some(x => m.team1.includes(x)) ? 1 : 0;
          const isWin = inT1 ? !!win1 : !win1;
          isWin ? proWin++ : proLoss++;
          continue; // í”„ë¡œë¦¬ê·¸ëŠ” ì¼ë°˜ì „/íŒ€ì „ ì§‘ê³„ì— í¬í•¨ë˜ì§€ ì•ŠìŒ
        }

        // âœ… ì¼ë°˜ì „
        if (isSolo && (m.player1===playerId || m.player2===playerId)) {
          const isWin = (m.winner===playerId);
          isWin ? soloWin++ : soloLoss++;
          if (isSC) (isWin ? scWin++ : scLoss++);
          if (isHT) (isWin ? htWin++ : htLoss++);
        }

        if (isTeam && ((m.team1||[]).includes(playerId) || (m.team2||[]).includes(playerId))) {
          const isTeam1 = m.team1.includes(playerId);
          const winners = Array.isArray(m.winner) ? m.winner : [];
          const win1 = winners.some(x => m.team1.includes(x)) ? 1 : 0;
          const isWin = isTeam1 ? !!win1 : !win1;
          isWin ? teamWin++ : teamLoss++;
          if (isSC) (isWin ? scWin++ : scLoss++);
          if (isHT) (isWin ? htWin++ : htLoss++);
        }
      }

      // --- í†µê³„ ì˜ì—­: ì¤‘ë³µ ì‚½ì… ë°©ì§€ìš© ê³ ì • ì—˜ë¦¬ë¨¼íŠ¸ ---
      let statsEl = document.getElementById('modalStats');
      if (!statsEl) {
        statsEl = document.createElement('div');
        statsEl.id = 'modalStats';
        statsEl.style.margin = '10px 0 14px 0';
        statsEl.style.color = '#ccc';
        statsEl.style.fontSize = '14px';
        const infoEl = document.getElementById('modalPlayerInfo');
        infoEl.insertAdjacentElement('afterend', statsEl);
      }

      // --- í†µê³„ ë‚´ìš© ê°±ì‹  ---
      statsEl.innerHTML = `
        <div>
          ğŸ† <b>í”„ë¡œë¦¬ê·¸:</b> ${proWin}ìŠ¹ ${proLoss}íŒ¨<br>
          <b>ê°œì¸ì „:</b> ${soloWin}ìŠ¹ ${soloLoss}íŒ¨,
          <b>íŒ€ì „:</b> ${teamWin}ìŠ¹ ${teamLoss}íŒ¨
          <span style="color:#888">(íŒ€ì „ì€ ìƒì»¨Â·í—Œí„° ëª¨ë‘ í¬í•¨)</span><br>
          <b>ìƒì»¨:</b> ${scWin}ìŠ¹ ${scLoss}íŒ¨,
          <b>í—Œí„°:</b> ${htWin}ìŠ¹ ${htLoss}íŒ¨
        </div>
      `;

      // --- ELO ë³€í™” ì°¨íŠ¸ ---
      const ctx=document.getElementById('modalEloChart').getContext('2d');
      if(window.modalChart)window.modalChart.destroy();
      window.modalChart=new Chart(ctx,{
        type:'line',
        data:{
          labels:target.history.map((_,i)=>i),
          datasets:[{label:'ELO',data:target.history,borderColor:'#ff6a00',borderWidth:2,fill:false,tension:0.3}]
        },
        options:{
          plugins:{legend:{display:false}},
          scales:{
            x:{ticks:{color:'#ccc'}},
            y:{ticks:{color:'#ccc'}}
          }
        }
      });

      // --- ê²½ê¸° ë¡œê·¸ í‘œì‹œ (ELO ë³€ë™ í¬í•¨) ---
      document.getElementById('modalMatchHistory').innerHTML =
        (playerLog.length? playerLog : []).map(row=>{
          const color = row.isWin ? '#4ade80' : '#f87171';
          const deltaText = (row.delta>0? `+${row.delta}` : `${row.delta}`);
          return `<div style="margin:4px 0;">
            ${row.date} | ${row.map}
            ${row.opponentText ? ` | vs ${row.opponentText}` : ''}
            | <b style="color:${color}">${row.isWin ? 'ìŠ¹' : 'íŒ¨'}</b>
            | <span style="color:${color}">${deltaText}</span>
            <span style="color:#aaa"> (í˜„ì¬ ELO: ${row.eloAfter})</span>
          </div>`;
        }).join('') || 'ê²½ê¸° ê¸°ë¡ ì—†ìŒ';

      // --- íŒì—… ì œì–´ ---
      const modal=document.getElementById('playerModal');
      modal.style.display='block';
      document.getElementById('closeModal').onclick=()=>modal.style.display='none';
      window.onclick=(e)=>{if(e.target===modal)modal.style.display='none';};
      window.addEventListener('keydown',(e)=>{if(e.key==='Escape')modal.style.display='none';},{once:true});
    } 
    catch(err){ console.error('íŒì—… ë¡œì§ ì˜¤ë¥˜:', err); }
  }
})();
</script>


</body>
</html>
