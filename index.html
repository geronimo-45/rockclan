<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>

  <!-- ✅ React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" defer></script>

  <!-- ✅ PropTypes (전역 주입: Recharts보다 반드시 먼저 로드) -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js" defer></script>

  <!-- ✅ 안정 버전 Recharts (버그 회피) -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js" defer></script>

  <!-- favicon 404 억제 -->
  <link rel="icon" type="image/x-icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root {
      --bg1:#0b0710; --bg2:#14050a; --accent:#ff6a00; --muted:#a7a0a8; --card:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters>*{flex:1 1 160px}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .match-header{font-weight:700;margin-bottom:6px;cursor:pointer;color:#ffb347}
    .match-item{color:#ddd;font-size:14px;margin:4px 0;padding-left:8px}
    .hidden{display:none;}
  </style>
</head>

<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">클랜원 랭킹 • 기록실 • ELO 시스템 설명 • 변동 그래프</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">클랜원 랭킹</button>
    <button class="tab" data-tab="records">기록실</button>
    <button class="tab" data-tab="elo-info">ELO 시스템 설명</button>
    <button class="tab" data-tab="chart">ELO 변동 그래프</button>
  </nav>
<!-- 🔹 플레이어 히스토리 팝업 -->
<div id="playerModal" class="modal" style="position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.6);padding-top:60px;display:none;">
  <div class="modal-content" style="background:#1a1a22;margin:auto;padding:20px;border-radius:12px;width:85%;max-height:80%;overflow-y:auto;color:#eee;box-shadow:0 0 20px rgba(0,0,0,.6)">
    <span id="closeModal" class="close" style="float:right;font-size:28px;cursor:pointer;color:#aaa">&times;</span>
    <h2 id="modalPlayerName" style="color:#ff6a00;margin-top:0;"></h2>
    <div id="modalPlayerInfo" style="font-size:14px;margin-bottom:12px;color:#ccc;"></div>
    <canvas id="modalEloChart" width="600" height="250" style="background:#111;border-radius:8px;margin-bottom:16px;"></canvas>
    <div id="modalMatchHistory" style="font-size:14px;color:#ddd;"></div>
  </div>
</div>

  <main>
    <!-- 랭킹 -->
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">클랜원 랭킹</h2>
        <div class="filters">
          <input id="search" placeholder="ID 검색" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">종족 전체</option>
            <option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">티어 전체</option>
            <option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">현재 ELO 순서 기준</div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>종족</th><th>티어</th><th>ELO</th><th>승</th><th>패</th><th>승률</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 기록실 -->
    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">기록실</h2>
        <div id="match-list"></div>
      </div>
    </section>

    <!-- ELO 설명 (원본 스타일 유지) -->
<section id="elo-info">
  <div class="card">
    <h2 style="margin:6px 0;color:var(--accent)">ELO 시스템 설명</h2>

    <p style="line-height:1.6;color:#ddd">
      RockClan의 ELO 시스템은 단순한 점수 차이뿐 아니라 <b>티어(Tier) 보정</b>을 포함하여 실제 실력 격차를 반영합니다.<br>
      모든 계산은 기록실(match) 데이터를 기반으로 자동 수행됩니다.
    </p>

    <ul style="line-height:1.8;color:#ccc;margin-left:12px">
      <li><b>초기 ELO</b>: 신규 플레이어는 1000점으로 시작합니다.</li>
      <li><b>K 값</b>:
        <ul>
          <li>개인전(1:1): <b>K = 12</b></li>
          <li>팀전(2:2, 3:3, 4:4 등): <b>K = 8</b></li>
        </ul>
      </li>
      <li><b>티어 인덱스 보정</b>:
        <ul>
          <li>Stone=0, Bronze=1, Silver=2, Gold=3, Diamond=4, Legend=5</li>
          <li>실제 계산은 <code>EffectiveElo = ELO + (TierIndex × 40)</code> 으로 수행됩니다.</li>
        </ul>
      </li>
      <li>예상 승률은 두 플레이어의 <b>EffectiveElo</b> 차이를 기준으로 계산됩니다.</li>
      <li>경기 결과는 예상 승률 대비 실제 승패 차이만큼 ELO가 변동합니다.</li>
    </ul>

    <h3 style="margin-top:16px;color:var(--accent)">📈 ELO 계산 예시</h3>
    <table style="width:100%;border-collapse:collapse;margin-top:8px;font-size:14px;color:#ddd">
      <thead>
        <tr style="background:rgba(255,255,255,0.05)">
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">상황</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">ELO 차이</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">티어 차이</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">예상 승률</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">승리 시</th>
          <th style="padding:6px;border:1px solid rgba(255,255,255,0.1)">패배 시</th>
        </tr>
      </thead>
      <tbody>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">1:1 (동티어, 동일 ELO)</td><td>0</td><td>0</td><td>50%</td><td>+6</td><td>−6</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">Silver(2) vs Gold(3)</td><td>0</td><td>+1</td><td>46%</td><td>+7</td><td>−5</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">Gold(3) vs Silver(2)</td><td>0</td><td>−1</td><td>54%</td><td>+5</td><td>−7</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">팀전 (평균 동티어)</td><td>0</td><td>0</td><td>50%</td><td>+4</td><td>−4</td></tr>
        <tr><td style="padding:6px;border:1px solid rgba(255,255,255,0.1)">팀전 (상대팀 평균 Diamond↑)</td><td>−150</td><td>+2</td><td>32%</td><td>+6</td><td>−3</td></tr>
      </tbody>
    </table>

    <p style="margin-top:10px;color:#999">
      ※ ELO 계산식: <code>NewElo = OldElo + K × (Actual − Expected)</code><br>
      ※ 티어 인덱스 보정으로 인해 상위 티어를 이길 경우 상승폭이 더 커집니다.
    </p>

    <!-- 🔹 시뮬레이터 -->
    <h3 style="margin-top:30px;color:var(--accent)">🧮 ELO 계산 시뮬레이터</h3>
    <div style="color:#ddd;font-size:14px;line-height:1.8;">
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px;">
        <label>플레이어 A ELO <input id="eloA" type="number" value="1000" style="width:80px;margin-left:6px;padding:4px;background:#111;border:1px solid #333;color:#fff;"></label>
        <label>티어
          <select id="tierA" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option>Stone</option><option>Bronze</option><option selected>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </label>
        <span style="margin:0 12px;">vs</span>
        <label>플레이어 B ELO <input id="eloB" type="number" value="1000" style="width:80px;margin-left:6px;padding:4px;background:#111;border:1px solid #333;color:#fff;"></label>
        <label>티어
          <select id="tierB" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option>Stone</option><option>Bronze</option><option>Silver</option><option selected>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </label>
        <label style="margin-left:16px;">경기 타입
          <select id="gameType" style="padding:4px;background:#111;border:1px solid #333;color:#fff;">
            <option value="1v1" selected>1:1</option>
            <option value="team">팀전</option>
          </select>
        </label>
        <button id="calcBtn" style="margin-left:12px;padding:6px 12px;border:none;border-radius:6px;background:var(--accent);color:#111;cursor:pointer;">계산</button>
      </div>

      <div id="simResult" style="margin-top:10px;padding:10px;border:1px solid rgba(255,255,255,0.1);border-radius:8px;background:rgba(255,255,255,0.03);">
        계산 결과가 여기에 표시됩니다.
      </div>
    </div>

    <script>
      document.getElementById("calcBtn").addEventListener("click",()=>{
        const getTierIndex=t=>["Stone","Bronze","Silver","Gold","Diamond","Legend"].indexOf(t);
        const eloA=parseFloat(document.getElementById("eloA").value||1000);
        const eloB=parseFloat(document.getElementById("eloB").value||1000);
        const tierA=document.getElementById("tierA").value;
        const tierB=document.getElementById("tierB").value;
        const gameType=document.getElementById("gameType").value;
        const K=(gameType==="team")?8:12;

        const effA=eloA+getTierIndex(tierA)*40;
        const effB=eloB+getTierIndex(tierB)*40;
        const expectedA=1/(1+Math.pow(10,(effB-effA)/400));
        const deltaWin = K*(1-expectedA);
        const deltaLose = -K*(expectedA);
        const winPct=(expectedA*100).toFixed(1);

        document.getElementById("simResult").innerHTML=`
          <div><b>예상 승률</b>: A ${winPct}% / B ${(100-expectedA*100).toFixed(1)}%</div>
          <div><b>K값</b>: ${K}</div>
          <div><b>A 승리 시</b>: A +${deltaWin.toFixed(2)} / B ${deltaLose.toFixed(2)}</div>
          <div><b>B 승리 시</b>: A ${(-deltaWin).toFixed(2)} / B +${(-deltaLose).toFixed(2)}</div>
        `;
      });
    </script>

  </div>
</section>


    <!-- 그래프 -->
    <section id="chart">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO 변동 그래프</h2>
        <div class="muted">여러 명을 선택해 날짜 기준으로 비교합니다. (X축: MM/DD, Y축: 800~1200)</div>
        <div id="elo-chart-container" style="margin-top:16px;"></div>
      </div>
    </section>
  </main>

  <!-- ✅ 모든 스크립트는 DOMContentLoaded 이후 안전하게 실행 -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 탭 전환 (원본 로직 보존)
    document.querySelectorAll('nav .tab').forEach(btn=>{
      btn.addEventListener('click', e=>{
        document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
        document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
      });
    });

    // ---------- 안전 로더: CORS/MIME/캐시 우회 + 경로 자동 ----------
    const safe = async (url) => {
      try {
        const res = await fetch(url + (url.includes('?')?'&':'?') + 'v=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const txt = await res.text();
        try { return JSON.parse(txt); }
        catch (e) { console.error('❌ JSON 파싱 실패:', url, txt.slice(0,200)); return {players:[], matches:[]}; }
      } catch (e) {
        console.error('❌ 로드 실패:', url, e);
        return {players:[], matches:[]};
      }
    };

    // 현재 문서 폴더 기준 절대경로 생성 (rockclan/ 여부와 무관하게 동작)
    const basePath = location.pathname.replace(/[^\/]*$/, ''); // 마지막 파일명 제거
    const path = (name) => basePath + name;

    // ---------- ELO 계산 준비 ----------
    const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
    const getTierIndex = t => Math.max(0, TierOrder.indexOf(t||'Silver'));
    const toMMDD = d => d ? d.split('-').slice(1).join('/') : '';

    // 필터 상태
    const $search = document.getElementById('search');
    const $race   = document.getElementById('raceFilter');
    const $tier   = document.getElementById('tierFilter');

    // ---------- 메인 시작 ----------
    start();

    async function start(){
      // 데이터 로드
      const base = await safe(path('data.json'));
      const oct  = await safe(path('data_oct.json'));

      // 병합
      base.matches = (base.matches||[]).concat(oct.matches||[]);
      const seen = new Set((base.players||[]).map(p=>p.id));
      (oct.players||[]).forEach(p=>{ if(!seen.has(p.id)) base.players.push(p); });

      // 렌더
      renderAll(base);
    }

    function renderAll(data){
      // 메타 맵
      const playersMeta = new Map((data.players||[]).map(p=>[p.id,p]));

      // 누적 스탯 & 그래프용
      const stat = new Map();
      const eloByDate = {}; // { id: { 'MM/DD': eloInt } }

      const ensure = (id)=>{
        if(stat.has(id)) return stat.get(id);
        const m=playersMeta.get(id)||{};
        const o={ id, elo:1000, tier:m.tier||'Silver', race:m.race||'Protoss', win:0, loss:0, played:0 };
        stat.set(id,o); return o;
      };

      const calc = (A,B,res,isTeam)=>{
        const K = isTeam? 8 : 12;
        const effA = A.elo + getTierIndex(A.tier)*40;
        const effB = B.elo + getTierIndex(B.tier)*40;
        const expectedA = 1/(1+Math.pow(10,(effB-effA)/400));
        const delta = K*(res-expectedA);
        A.elo += delta; B.elo -= delta;
      };

      // 날짜순 처리
      const matches = (data.matches||[]).slice().sort((a,b)=>String(a.date).localeCompare(String(b.date)));

      // ▶ "map":"Match" 는 계산/랭킹/그래프 제외, 기록실에는 표시
      for(const m of matches){
        if(!m.map || m.map==='Match') continue;
        const d = toMMDD(m.date);

        // 1v1
        if(m.player1 && m.player2){
          const p1=ensure(m.player1), p2=ensure(m.player2);
          if(m.winner===m.player1){ calc(p1,p2,1,false); p1.win++; p2.loss++; }
          else if(m.winner===m.player2){ calc(p1,p2,0,false); p2.win++; p1.loss++; }
          p1.played++; p2.played++;
          (eloByDate[p1.id]??={})[d]=Math.round(p1.elo);
          (eloByDate[p2.id]??={})[d]=Math.round(p2.elo);
        }

        // 팀전
        if(Array.isArray(m.team1) && Array.isArray(m.team2)){
          const T1=m.team1.map(ensure), T2=m.team2.map(ensure);
          const winners = Array.isArray(m.winner)? m.winner : [];
          const win1 = winners.some(x=>m.team1.includes(x)) ? 1 : 0;

          const avg1=T1.reduce((a,b)=>a+b.elo,0)/T1.length;
          const avg2=T2.reduce((a,b)=>a+b.elo,0)/T2.length;
          const dA={elo:avg1,tier:'Silver'}, dB={elo:avg2,tier:'Silver'};
          calc(dA,dB,win1,true);
          const diffA=dA.elo-avg1, diffB=dB.elo-avg2;

          T1.forEach(p=>{ p.elo+=diffA; p.played++; win1?p.win++:p.loss++; (eloByDate[p.id]??={})[d]=Math.round(p.elo); });
          T2.forEach(p=>{ p.elo+=diffB; p.played++; !win1?p.win++:p.loss++; (eloByDate[p.id]??={})[d]=Math.round(p.elo); });
        }
      }

      // --- 랭킹 표시 (ELO 내림차순) + 필터 ---
      const tbody = document.querySelector('#players-table tbody');
      const allRows = [...stat.values()].sort((a,b)=>b.elo-a.elo);

      function applyFilters(){
        const q = ($search.value||'').trim().toLowerCase();
        const r = $race.value||'';
        const t = $tier.value||'';

        const filtered = allRows.filter(p=>{
          if(q && !p.id.toLowerCase().includes(q)) return false;
          if(r && p.race!==r) return false;
          if(t && p.tier!==t) return false;
          return true;
        });

        tbody.innerHTML = filtered.map((p,i)=>{
          const wr = p.played? ((p.win/p.played)*100).toFixed(1) : '0.0';
          return `<tr>
            <td>${i+1}</td><td>${p.id}</td><td>${p.race}</td>
            <td class="tier-${p.tier}">${p.tier}</td>
            <td>${Math.round(p.elo)}</td><td>${p.win}</td><td>${p.loss}</td><td>${wr}%</td>
          </tr>`;
        }).join('');
      }
      ['input','change'].forEach(ev=>{
        $search.addEventListener(ev,applyFilters);
        $race.addEventListener(ev,applyFilters);
        $tier.addEventListener(ev,applyFilters);
      });
      applyFilters();

      // --- 기록실: 기본 접힘 + 날짜 헤더에 Match n게임 ---
      const list = document.getElementById('match-list');
      list.innerHTML='';
      let curDate=null, box=null, mCount=0;

      const flushHeader = ()=>{ if(box && mCount>0){ box.querySelector('.match-header').textContent += ` (Match ${mCount}게임)`; } };

      for(const m of matches){
        if(m.date!==curDate){
          flushHeader();
          curDate=m.date; mCount=0;
          box=document.createElement('div');
          box.className='match';
          const hdr=document.createElement('div');
          hdr.className='match-header';
          hdr.textContent=`${curDate}`;
          const inner=document.createElement('div');
          inner.className='match-inner hidden';
          hdr.addEventListener('click',()=>inner.classList.toggle('hidden'));
          box.appendChild(hdr); box.appendChild(inner);
          list.appendChild(box);
        }
        const wrap=box.querySelector('.match-inner');
        if(m.map==='Match'){
          mCount++;
          const line=document.createElement('div');
          line.className='match-item';
          line.style.color='#a8e0a8';
          const win = Array.isArray(m.winner)? m.winner.join(', ') : (m.winner||'-');
          line.textContent=`[Match] 승자: ${win}${m.score?` | 스코어: ${m.score}`:''}`;
          wrap.appendChild(line);
          continue;
        }
        if(m.player1&&m.player2){
          const l=document.createElement('div'); l.className='match-item';
          l.textContent=`${m.map||'-'} — ${m.player1} vs ${m.player2} | 승자: ${m.winner||'-'}${m.score?` | ${m.score}`:''}`;
          wrap.appendChild(l);
        }
        if(Array.isArray(m.team1)&&Array.isArray(m.team2)){
          const l=document.createElement('div'); l.className='match-item';
          const win = Array.isArray(m.winner)? m.winner.join(', ') : (m.winner||'-');
          l.textContent=`${m.map||'-'} — [${m.team1.join(', ')}] vs [${m.team2.join(', ')}] | 승자: ${win}${m.score?` | ${m.score}`:''}`;
          wrap.appendChild(l);
        }
      }
      flushHeader();

      // --- 그래프 렌더 ---
      renderChart(eloByDate);
    }

    function renderChart(eloByDate){
      const container=document.getElementById('elo-chart-container');
      container.innerHTML = `
        <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
          <div>
            <div style="font-size:13px;color:#aaa;margin-bottom:6px">비교할 플레이어 선택 (Ctrl/⌘ 다중 선택)</div>
            <select id="eloPlayerSelect" multiple size="10"
              style="min-width:220px;height:200px;padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
              ${Object.keys(eloByDate).sort().map(id=>`<option value="${id}">${id}</option>`).join('')}
            </select>
          </div>
          <div id="eloChartArea" style="flex:1;min-width:320px;width:100%;height:460px"></div>
        </div>
      `;

      const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts || {};
      const area = document.getElementById('eloChartArea');
      if(!LineChart){ area.innerHTML=`<div class="muted">Recharts가 아직 로드되지 않았습니다.</div>`; return; }

      const palette=["#ff6a00","#4ade80","#60a5fa","#f472b6","#facc15","#38bdf8","#a78bfa","#fb923c","#22d3ee","#94a3b8"];

      function draw(sel){
        if(!sel.length){ area.innerHTML=`<div class="muted">왼쪽에서 1명 이상 선택하세요.</div>`; return; }
        const dates=[...new Set(sel.flatMap(id=>Object.keys(eloByDate[id]||{})))].sort((a,b)=>{
          const [am,ad]=a.split('/').map(Number), [bm,bd]=b.split('/').map(Number);
          return am===bm? ad-bd : am-bm;
        });
        const rows=dates.map(d=>{ const r={date:d}; sel.forEach(id=>r[id]=eloByDate[id]?.[d]??null); return r; });

        ReactDOM.render(
          React.createElement(
            ResponsiveContainer,{width:"100%",height:460},
            React.createElement(LineChart,{data:rows,margin:{top:20,right:30,left:0,bottom:0}},
              React.createElement(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.12)"}),
              React.createElement(XAxis,{dataKey:"date",stroke:"#aaa",tick:{fontSize:12}}),
              React.createElement(YAxis,{stroke:"#aaa",domain:[800,1200],tick:{fontSize:12}}),
              React.createElement(Tooltip,{formatter:v=>Math.round(v),contentStyle:{backgroundColor:"#1a1a22",border:"1px solid #333"}}),
              React.createElement(Legend,null),
              ...sel.map((id,i)=>React.createElement(Line,{
                key:id, type:"monotone", dataKey:id, name:id,
                stroke:palette[i%palette.length], dot:false, strokeWidth:2, isAnimationActive:false
              }))
            )
          ), area
        );
      }

      document.getElementById('eloPlayerSelect').addEventListener('change', e=>{
        const sel=[...e.target.selectedOptions].map(o=>o.value);
        draw(sel);
      });
    }
  });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const tbody=document.querySelector('#players-table tbody');
  if(!tbody)return;

  tbody.addEventListener('click',e=>{
    const tr=e.target.closest('tr');
    if(!tr)return;
    const playerId=tr.children[1]?.textContent.trim();
    if(playerId) showPlayerModal(playerId);
  });

  async function showPlayerModal(playerId){
    // 데이터 로드 (기존 그대로)
    const base=await fetch('data.json?v='+Date.now()).then(r=>r.json()).catch(()=>({players:[],matches:[]}));
    const oct=await fetch('data_oct.json?v='+Date.now()).then(r=>r.json()).catch(()=>({players:[],matches:[]}));
    base.matches=(base.matches||[]).concat(oct.matches||[]);
    const seen=new Set(base.players.map(p=>p.id));
    (oct.players||[]).forEach(p=>{if(!seen.has(p.id))base.players.push(p);});

    const player=base.players.find(p=>p.id===playerId);
    if(!player)return;

    // ELO 계산 유틸 (기존과 동일)
    const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
    const getTierIndex=t=>Math.max(0,TierOrder.indexOf(t||'Silver'));
    const calc=(A,B,res,isTeam)=>{
      const K=isTeam?8:12;
      const effA=A.elo+getTierIndex(A.tier)*40;
      const effB=B.elo+getTierIndex(B.tier)*40;
      const expectedA=1/(1+Math.pow(10,(effB-effA)/400));
      const delta=K*(res-expectedA);
      A.elo+=delta;B.elo-=delta;
    };

    // 선수 상태 맵과 ensure (기존과 동일)
    const stat=new Map();
    const ensure=(id)=>{
      if(stat.has(id))return stat.get(id);
      const meta=(base.players||[]).find(p=>p.id===id)||{};
      const o={id,tier:meta.tier||'Silver',race:meta.race||'Protoss',elo:1000,history:[1000]};
      stat.set(id,o);return o;
    };

    // 날짜순 매치 (map:"Match" 제외) — 팝업용 상세 로그를 동시에 구축
    const matches=(base.matches||[])
      .filter(m=>m.map!=="Match")
      .slice()
      .sort((a,b)=>String(a.date).localeCompare(String(b.date)));

    const playerLog=[]; // [{date,map,opponentText,isWin,eloAfter,delta}]

    for(const m of matches){
      // 1:1
      if(m.player1 && m.player2){
        const p1=ensure(m.player1), p2=ensure(m.player2);
        const res=(m.winner===m.player1)?1:(m.winner===m.player2)?0:null;

        // 내 경기라면 사전 ELO와 상대 확보
        let involved=false, eloBefore=0, opponentText='';
        if(m.player1===playerId){involved=true; eloBefore=p1.elo; opponentText=m.player2;}
        else if(m.player2===playerId){involved=true; eloBefore=p2.elo; opponentText=m.player1;}

        // 계산 적용
        if(res!==null){
          calc(p1,p2,res,false);
          p1.history.push(Math.round(p1.elo));
          p2.history.push(Math.round(p2.elo));
        }

        // 로그 적재 (경기 직후 기준)
        if(involved){
          const after = (m.player1===playerId)? p1.elo : p2.elo;
          const isWin = (m.winner===playerId);
          playerLog.push({
            date: m.date,
            map: m.map || '-',
            opponentText,
            isWin,
            eloAfter: Math.round(after),
            delta: Math.round(after - eloBefore)
          });
        }
      }

      // 팀전
      if(Array.isArray(m.team1) && Array.isArray(m.team2)){
        const T1=m.team1.map(ensure), T2=m.team2.map(ensure);
        const winners = Array.isArray(m.winner)? m.winner : [];
        const win1 = winners.some(x=>m.team1.includes(x)) ? 1 : 0;

        // 내 경기 여부/사전 ELO/상대편
        const inTeam1 = m.team1.includes(playerId);
        const inTeam2 = m.team2.includes(playerId);
        const involved = inTeam1 || inTeam2;

        let eloBefore=0, opponentText='';
        if(involved){
          const me = inTeam1 ? T1.find(p=>p.id===playerId) : T2.find(p=>p.id===playerId);
          eloBefore = me.elo;
          opponentText = (inTeam1 ? m.team2 : m.team1).join(', ');
        }

        // 팀 평균으로 계산 후 diff 분배
        const avg1 = T1.reduce((a,b)=>a+b.elo,0)/T1.length;
        const avg2 = T2.reduce((a,b)=>a+b.elo,0)/T2.length;
        const dA={elo:avg1,tier:'Silver'}, dB={elo:avg2,tier:'Silver'};
        calc(dA,dB,win1,true);
        const diffA=dA.elo-avg1, diffB=dB.elo-avg2;

        T1.forEach(p=>{p.elo+=diffA; p.history.push(Math.round(p.elo));});
        T2.forEach(p=>{p.elo+=diffB; p.history.push(Math.round(p.elo));});

        if(involved){
          const meAfter = (inTeam1 ? T1 : T2).find(p=>p.id===playerId).elo;
          const isWin = inTeam1 ? !!win1 : !win1;
          playerLog.push({
            date: m.date,
            map: m.map || '-',
            opponentText,
            isWin,
            eloAfter: Math.round(meAfter),
            delta: Math.round(meAfter - eloBefore)
          });
        }
      }
    }

    const target=stat.get(playerId);
    if(!target){alert("경기 기록이 없습니다.");return;}

    // 헤더 정보
    document.getElementById('modalPlayerName').textContent=player.id;
    document.getElementById('modalPlayerInfo').innerHTML=
      `<b>Race:</b> ${player.race} | <b>Tier:</b> ${player.tier} | <b>현재 ELO:</b> ${Math.round(target.elo)} (${target.history.length-1}경기)`;

    // 차트 (그대로)
    const ctx=document.getElementById('modalEloChart').getContext('2d');
    if(window.modalChart)window.modalChart.destroy();
    window.modalChart=new Chart(ctx,{
      type:'line',
      data:{labels:target.history.map((_,i)=>i),datasets:[{label:'ELO',data:target.history,borderColor:'#ff6a00',borderWidth:2,fill:false,tension:0.3}]},
      options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#ccc'}},y:{ticks:{color:'#ccc'}}}}
    });

    // 🔹 팝업 리스트: 날짜 | 맵 | vs 상대 | 승/패 | ELO 변동 | (현재 ELO: NNNN)
    document.getElementById('modalMatchHistory').innerHTML =
      (playerLog.length? playerLog : []).map(row=>{
        const color = row.isWin ? '#4ade80' : '#f87171';
        const deltaText = (row.delta>0? `+${row.delta}` : `${row.delta}`);
        return `<div style="margin:4px 0;">
          ${row.date} | ${row.map}
          ${row.opponentText ? ` | vs ${row.opponentText}` : ''}
          | <b style="color:${color}">${row.isWin ? '승' : '패'}</b>
          | <span style="color:${color}">${deltaText}</span>
          <span style="color:#aaa"> (현재 ELO: ${row.eloAfter})</span>
        </div>`;
      }).join('') : '경기 기록 없음';

    // 모달 오픈/닫기 (그대로)
    const modal=document.getElementById('playerModal');
    modal.style.display='block';
    document.getElementById('closeModal').onclick=()=>modal.style.display='none';
    window.onclick=(e)=>{if(e.target===modal)modal.style.display='none';};
    window.addEventListener('keydown',(e)=>{if(e.key==='Escape')modal.style.display='none';},{once:true});
  }
});
</script>


</body>
</html>
