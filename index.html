<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>

  <!-- ✅ React / ReactDOM (반드시 최상단) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- ✅ PropTypes (Recharts보다 반드시 먼저 선언되어야 함) -->
  <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

  <!-- ✅ 예비: PropTypes 폴리필 (혹시 CDN이 느릴 경우 대비용) -->
  <script>
    if (!window.PropTypes) {
      window.PropTypes = {
        oneOfType: () => () => null,
        oneOf: () => () => null,
        string: () => null,
        number: () => null,
        array: () => null,
        object: () => null,
        func: () => null,
        bool: () => null,
        shape: () => () => null,
        node: () => null,
        element: () => null
      };
      console.log("⚠️ PropTypes 폴리필 적용됨");
    }
  </script>

  <!-- ✅ 안정 버전 Recharts (2.10.3) — 캐시 무효화 쿼리 포함 -->
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.3/umd/Recharts.min.js?v=2"></script>

  <!-- ✅ 안전 확인 로그 -->
  <script>
    console.log("✅ PropTypes loaded:", !!window.PropTypes);
    console.log("✅ oneOfType:", typeof window.PropTypes?.oneOfType);
    console.log("✅ Recharts loaded:", !!window.Recharts);
  </script>

  <!-- favicon 404 방지 -->
  <link rel="icon" type="image/x-icon" href="data:;base64,iVBORw0KGgo=">

  <style>
    :root {
      --bg1:#0b0710;
      --bg2:#14050a;
      --accent:#ff6a00;
      --muted:#a7a0a8;
      --card:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;
      margin:0;color:#eee;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
    }
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .filters>*{flex:1 1 160px}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .match-header{font-weight:700;margin-bottom:6px;cursor:pointer;color:#ffb347}
    .match-item{color:#ddd;font-size:14px;margin:4px 0;padding-left:8px}
    .hidden{display:none;}
  </style>
</head>


<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">클랜원 랭킹 • 기록실 • ELO 시스템 설명 • 변동 그래프</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">클랜원 랭킹</button>
    <button class="tab" data-tab="records">기록실</button>
    <button class="tab" data-tab="elo-info">ELO 시스템 설명</button>
    <button class="tab" data-tab="chart">ELO 변동 그래프</button>
  </nav>

  <main>
    <!-- 🔹 클랜원 랭킹 -->
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">클랜원 랭킹</h2>
        <div class="filters">
          <input id="search" placeholder="ID 검색" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
          <select id="raceFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">종족 전체</option>
            <option>Protoss</option><option>Terran</option><option>Zerg</option><option>Random</option>
          </select>
          <select id="tierFilter" style="padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
            <option value="">티어 전체</option>
            <option>Stone</option><option>Bronze</option><option>Silver</option><option>Gold</option><option>Diamond</option><option>Legend</option>
          </select>
        </div>
        <div class="muted" style="font-size:13px;margin-bottom:6px">현재 ELO 순서 기준</div>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>종족</th><th>티어</th><th>ELO</th><th>승</th><th>패</th><th>승률</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 기록실 -->
    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">기록실</h2>
        <div id="match-list"></div>
      </div>
    </section>

    <!-- 🔹 ELO 설명 -->
    <section id="elo-info">
      <div class="card">
        <h2 style="color:#ff6a00;margin:6px 0;">ELO 시스템 설명</h2>
        <p style="color:#ddd;line-height:1.6;">
          RockClan의 ELO 시스템은 단순한 점수 차이뿐 아니라 <b>티어(Tier) 보정</b>을 포함하여 실제 실력 격차를 반영합니다.<br>
          모든 계산은 기록실(match) 데이터를 기반으로 자동 수행됩니다.
        </p>
        <ul style="line-height:1.6;color:#ddd;">
          <li>초기 ELO: 신규 플레이어는 1000점으로 시작합니다.</li>
          <li>K 값:<br> - 개인전(1:1): <b>K=12</b><br> - 팀전(2:2, 3:3, 4:4 등): <b>K=8</b></li>
          <li>티어 인덱스 보정:<br> Stone=0, Bronze=1, Silver=2, Gold=3, Diamond=4, Legend=5</li>
          <li>계산식: <code>EffectiveElo = ELO + (TierIndex × 40)</code></li>
        </ul>
        <h3 style="color:#ff6a00;margin-top:20px;">📘 ELO 계산 예시</h3>
        <table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:14px;color:#ccc;">
          <thead><tr style="color:#ffb347;"><th>상황</th><th>ELO 차이</th><th>티어 차이</th><th>예상 승률</th><th>승리 시</th><th>패배 시</th></tr></thead>
          <tbody>
            <tr><td>1:1 (동티어, 동일 ELO)</td><td>0</td><td>0</td><td>50%</td><td>+6</td><td>-6</td></tr>
            <tr><td>Silver vs Gold</td><td>0</td><td>+1</td><td>46%</td><td>+7</td><td>-5</td></tr>
            <tr><td>Gold vs Silver</td><td>0</td><td>-1</td><td>54%</td><td>+5</td><td>-7</td></tr>
            <tr><td>팀전 (동티어)</td><td>0</td><td>0</td><td>50%</td><td>+4</td><td>-4</td></tr>
            <tr><td>팀전 (상대팀 Diamond ↑)</td><td>-150</td><td>+2</td><td>32%</td><td>+6</td><td>-3</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 🔹 ELO 그래프 -->
    <section id="chart">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO 변동 그래프</h2>
        <div class="muted">여러 명을 선택해 날짜 기준으로 비교합니다. (X축: MM/DD, Y축: 800~1200)</div>
        <div id="elo-chart-container" style="margin-top:16px;"></div>
      </div>
    </section>
  </main>

<script>
  // ✅ 탭 전환
  document.querySelectorAll('nav .tab').forEach(btn=>{
    btn.addEventListener('click',e=>{
      document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
    });
  });

  // ✅ 안전한 데이터 로드
  const safe=async(url)=>{
    try{
      const res=await fetch(url+'?v='+Date.now(),{cache:'no-store'});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt=await res.text();
      return JSON.parse(txt);
    }catch(e){
      console.warn('로드 실패',url,e);
      return {players:[],matches:[]};
    }
  };

  const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
  const getTierIndex=t=>Math.max(0,TierOrder.indexOf(t||'Silver'));
  const toMMDD=d=>d?d.split('-').slice(1).join('/'):'';

  async function start(){
// ✅ GitHub Pages 환경에서도 확실히 동작하도록 경로 보정
const pathPrefix = window.location.pathname.includes('/rockclan')
  ? '/rockclan/'
  : './';
const base = await safe(`${pathPrefix}data.json`);
const oct  = await safe(`${pathPrefix}data_oct.json`);
    base.matches=(base.matches||[]).concat(oct.matches||[]);
    const seen=new Set(base.players.map(p=>p.id));
    (oct.players||[]).forEach(p=>{if(!seen.has(p.id))base.players.push(p)});
