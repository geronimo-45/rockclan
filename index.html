<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RockClan Records</title>

  <!-- React / ReactDOM / Recharts -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts@2.12.0/umd/Recharts.min.js"></script>

  <style>
    :root{--bg1:#0b0710;--bg2:#14050a;--accent:#ff6a00;--muted:#a7a0a8;--card:rgba(255,255,255,0.03);}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans KR','Apple SD Gothic Neo','Malgun Gothic',sans-serif;margin:0;color:#eee;background:linear-gradient(180deg,var(--bg1),var(--bg2));}
    header{padding:20px;text-align:center;background:linear-gradient(90deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    header h1{margin:0;color:var(--accent)}
    header .sub{color:var(--muted);font-size:13px;margin-top:6px}
    nav{display:flex;gap:10px;justify-content:center;padding:10px;background:#14141a;position:sticky;top:0;z-index:2}
    nav button{background:#1a1a22;border:1px solid #232532;color:#ddd;padding:10px 14px;border-radius:10px;cursor:pointer}
    nav button.active{background:var(--accent);color:#111}
    main{max-width:1100px;margin:18px auto;padding:0 16px}
    section{display:none}
    section.active{display:block}
    .card{background:var(--card);padding:14px;border-radius:12px;margin-bottom:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.06);text-align:center}
    th{color:var(--muted);font-size:12px;text-transform:uppercase}
    tr:hover{background:rgba(255,255,255,0.03)}
    .tier-Stone{color:#8b8b8b}.tier-Bronze{color:#cd7f32}.tier-Silver{color:#c0c0c0}.tier-Gold{color:#ffd700}.tier-Diamond{color:#67e8f9}.tier-Legend{color:#ff7f50}
    .muted{color:var(--muted)}
    .match{border:1px solid rgba(255,255,255,0.08);padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);margin-bottom:10px}
    .match-header{font-weight:700;margin-bottom:6px;cursor:pointer;color:#ffb347}
    .match-item{color:#ddd;font-size:14px;margin:4px 0;padding-left:8px}
    .hidden{display:none;}
  </style>
</head>

<body>
  <header>
    <h1>RockClan Records</h1>
    <div class="sub">í´ëœì› ë­í‚¹ â€¢ ê¸°ë¡ì‹¤ â€¢ ELO ì‹œìŠ¤í…œ ì„¤ëª… â€¢ ë³€ë™ ê·¸ë˜í”„</div>
  </header>

  <nav>
    <button class="tab active" data-tab="players">í´ëœì› ë­í‚¹</button>
    <button class="tab" data-tab="records">ê¸°ë¡ì‹¤</button>
    <button class="tab" data-tab="elo-info">ELO ì‹œìŠ¤í…œ ì„¤ëª…</button>
    <button class="tab" data-tab="chart">ELO ë³€ë™ ê·¸ë˜í”„</button>
  </nav>

  <main>
    <!-- ë­í‚¹ -->
    <section id="players" class="active">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">í´ëœì› ë­í‚¹</h2>
        <table id="players-table">
          <thead><tr><th>Rank</th><th>ID</th><th>ì¢…ì¡±</th><th>í‹°ì–´</th><th>ELO</th><th>ìŠ¹</th><th>íŒ¨</th><th>ìŠ¹ë¥ </th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- ê¸°ë¡ì‹¤ -->
    <section id="records">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ê¸°ë¡ì‹¤</h2>
        <div id="match-list"></div>
      </div>
    </section>

    <!-- ELO ì‹œìŠ¤í…œ ì„¤ëª… -->
    <section id="elo-info">
      <div class="card">
        <h2 style="color:#ff6a00;margin:6px 0;">ELO ì‹œìŠ¤í…œ ì„¤ëª…</h2>
        <p style="color:#ddd;line-height:1.6;">
          RockClanì˜ ELO ì‹œìŠ¤í…œì€ ë‹¨ìˆœí•œ ì ìˆ˜ ì°¨ì´ë¿ ì•„ë‹ˆë¼ <b>í‹°ì–´(Tier) ë³´ì •</b>ì„ í¬í•¨í•˜ì—¬ ì‹¤ì œ ì‹¤ë ¥ ê²©ì°¨ë¥¼ ë°˜ì˜í•©ë‹ˆë‹¤.<br>
          ëª¨ë“  ê³„ì‚°ì€ ê¸°ë¡ì‹¤(match) ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìë™ ìˆ˜í–‰ë©ë‹ˆë‹¤.
        </p>
        <ul style="line-height:1.6;color:#ddd;">
          <li>ì´ˆê¸° ELO: ì‹ ê·œ í”Œë ˆì´ì–´ëŠ” 1000ì ìœ¼ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.</li>
          <li>K ê°’:<br>
            - ê°œì¸ì „(1:1): <b>K=12</b><br>
            - íŒ€ì „(2:2, 3:3, 4:4 ë“±): <b>K=8</b>
          </li>
          <li>í‹°ì–´ ì¸ë±ìŠ¤ ë³´ì •:<br>
            Stone=0, Bronze=1, Silver=2, Gold=3, Diamond=4, Legend=5
          </li>
          <li>ì‹¤ì œ ê³„ì‚°ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:<br>
            <code>EffectiveElo = ELO + (TierIndex Ã— 40)</code>
          </li>
          <li>ì˜ˆìƒ ìŠ¹ë¥ ì€ ë‘ í”Œë ˆì´ì–´ì˜ EffectiveElo ì°¨ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
          <li>ê²½ê¸° ê²°ê³¼ëŠ” ì˜ˆìƒ ìŠ¹ë¥  ëŒ€ë¹„ ì‹¤ì œ ìŠ¹íŒ¨ ì°¨ì´ë§Œí¼ ELOê°€ ë³€ë™ë©ë‹ˆë‹¤.</li>
        </ul>
        <h3 style="color:#ff6a00;margin-top:20px;">ğŸ“˜ ELO ê³„ì‚° ì˜ˆì‹œ</h3>
        <table style="width:100%;border-collapse:collapse;margin-top:6px;font-size:14px;color:#ccc;">
          <thead><tr style="color:#ffb347;"><th>ìƒí™©</th><th>ELO ì°¨ì´</th><th>í‹°ì–´ ì°¨ì´</th><th>ì˜ˆìƒ ìŠ¹ë¥ </th><th>ìŠ¹ë¦¬ ì‹œ</th><th>íŒ¨ë°° ì‹œ</th></tr></thead>
          <tbody>
            <tr><td>1:1 (ë™í‹°ì–´, ë™ì¼ ELO)</td><td>0</td><td>0</td><td>50%</td><td>+6</td><td>-6</td></tr>
            <tr><td>Silver(2) vs Gold(3), ë™ì </td><td>0</td><td>+1</td><td>46%</td><td>+7</td><td>-5</td></tr>
            <tr><td>Gold(3) vs Silver(2), ë™ì </td><td>0</td><td>-1</td><td>54%</td><td>+5</td><td>-7</td></tr>
            <tr><td>íŒ€ì „ (í‰ê·  ë™í‹°ì–´)</td><td>0</td><td>0</td><td>50%</td><td>+4</td><td>-4</td></tr>
            <tr><td>íŒ€ì „ (ìƒëŒ€íŒ€ í‰ê·  Diamond â†‘)</td><td>-150</td><td>+2</td><td>32%</td><td>+6</td><td>-3</td></tr>
          </tbody>
        </table>
        <p style="font-size:13px;color:#999;margin-top:6px;">
          â€» ELO ê³„ì‚°ì‹: <code>NewElo = OldElo + K Ã— (Actual - Expected)</code><br>
          â€» í‹°ì–´ ì¸ë±ìŠ¤ ë³´ì •ìœ¼ë¡œ ìƒìœ„ í‹°ì–´ë¥¼ ì´ê¸¸ ê²½ìš° ìƒìŠ¹í­ì´ ë” ì»¤ì§‘ë‹ˆë‹¤.
        </p>
      </div>
    </section>

    <!-- ELO ê·¸ë˜í”„ -->
    <section id="chart">
      <div class="card">
        <h2 style="margin:6px 0;color:var(--accent)">ELO ë³€ë™ ê·¸ë˜í”„</h2>
        <div class="muted">ì—¬ëŸ¬ ëª…ì„ ì„ íƒí•´ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë¹„êµí•©ë‹ˆë‹¤. (Xì¶•: MM/DD, Yì¶•: 800~1200)</div>
        <div id="elo-chart-container" style="margin-top:16px;"></div>
      </div>
    </section>
  </main>

<script>
  document.querySelectorAll('nav .tab').forEach(btn=>{
    btn.addEventListener('click',e=>{
      document.querySelectorAll('nav .tab').forEach(b=>b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
      document.getElementById(e.currentTarget.dataset.tab).classList.add('active');
    });
  });

  async function loadData(){
    const safe=async(u)=>{try{const r=await fetch(u,{cache:'no-cache'});return r.ok?await r.json():{players:[],matches:[]}}catch{return{players:[],matches:[]}}};
    const base=await safe('data.json'),oct=await safe('data_oct.json');
    base.matches=(base.matches||[]).concat(oct.matches||[]);
    const seen=new Set(base.players.map(p=>p.id)); (oct.players||[]).forEach(p=>{if(!seen.has(p.id))base.players.push(p)});
    return base;
  }

  const TierOrder=['Stone','Bronze','Silver','Gold','Diamond','Legend'];
  const getTierIndex=t=>Math.max(0,TierOrder.indexOf(t||'Silver'));
  const toMMDD=d=>d?d.split('-').slice(1).join('/'):'';

  async function start(){
    const data=await loadData();
    const playersMeta=new Map(data.players.map(p=>[p.id,p]));
    const stat=new Map(),eloByDate={};
    const ensure=id=>{if(stat.has(id))return stat.get(id);const p=playersMeta.get(id)||{};const o={id,elo:1000,tier:p.tier||'Silver',race:p.race||'Protoss',win:0,loss:0,played:0};stat.set(id,o);return o;};
    const calc=(A,B,res,isTeam)=>{const K=isTeam?8:12;const effA=A.elo+getTierIndex(A.tier)*40;const effB=B.elo+getTierIndex(B.tier)*40;const expA=1/(1+10**((effB-effA)/400));const delta=K*(res-expA);A.elo+=delta;B.elo-=delta;};
    const matches=data.matches.sort((a,b)=>String(a.date).localeCompare(String(b.date)));
    for(const m of matches){if(!m.map||m.map==='Match')continue;const d=toMMDD(m.date);
      if(m.player1&&m.player2){const p1=ensure(m.player1),p2=ensure(m.player2);
        if(m.winner===m.player1){calc(p1,p2,1,false);p1.win++;p2.loss++;}else if(m.winner===m.player2){calc(p1,p2,0,false);p2.win++;p1.loss++;}
        p1.played++;p2.played++;(eloByDate[p1.id]??={})[d]=Math.round(p1.elo);(eloByDate[p2.id]??={})[d]=Math.round(p2.elo);
      }
      if(Array.isArray(m.team1)&&Array.isArray(m.team2)){const T1=m.team1.map(ensure),T2=m.team2.map(ensure);
        const winArr=Array.isArray(m.winner)?m.winner:[],win1=winArr.some(x=>m.team1.includes(x))?1:0;
        const avg1=T1.reduce((a,b)=>a+b.elo,0)/T1.length,avg2=T2.reduce((a,b)=>a+b.elo,0)/T2.length;
        const dA={elo:avg1,tier:'Silver'},dB={elo:avg2,tier:'Silver'};calc(dA,dB,win1,true);
        const diffA=dA.elo-avg1,diffB=dB.elo-avg2;
        T1.forEach(p=>{p.elo+=diffA;p.played++;win1?p.win++:p.loss++;(eloByDate[p.id]??={})[d]=Math.round(p.elo);});
        T2.forEach(p=>{p.elo+=diffB;p.played++;!win1?p.win++:p.loss++;(eloByDate[p.id]??={})[d]=Math.round(p.elo);});
      }}
    const tbody=document.querySelector('#players-table tbody');
    tbody.innerHTML=[...stat.values()].map((p,i)=>{const w=p.played?((p.win/p.played)*100).toFixed(1):'0.0';return`<tr><td>${i+1}</td><td>${p.id}</td><td>${p.race}</td><td class="tier-${p.tier}">${p.tier}</td><td>${Math.round(p.elo)}</td><td>${p.win}</td><td>${p.loss}</td><td>${w}%</td></tr>`;}).join('');

    // ê¸°ë¡ì‹¤: ë‚ ì§œë³„ ì ‘í˜
    const list=document.getElementById('match-list');
    let curDate=null,curBox=null;
    for(const m of matches){
      if(m.date!==curDate){
        curDate=m.date;
        curBox=document.createElement('div');
        curBox.className='match';
        const hdr=document.createElement('div');
        hdr.className='match-header';
        hdr.textContent=`${curDate}`;
        const inner=document.createElement('div');
        inner.className='match-inner hidden';
        hdr.addEventListener('click',()=>inner.classList.toggle('hidden'));
        curBox.appendChild(hdr);
        curBox.appendChild(inner);
        list.appendChild(curBox);
      }
      const wrap=curBox.querySelector('.match-inner');
      if(m.map==='Match'){
        const line=document.createElement('div');
        const win=Array.isArray(m.winner)?m.winner.join(', '):(m.winner||'-');
        line.textContent=`[Match] ìŠ¹ì: ${win}${m.score?` | ìŠ¤ì½”ì–´: ${m.score}`:''}`;
        line.style.color='#a8e0a8';line.className='match-item';
        wrap.appendChild(line);continue;
      }
      if(m.player1&&m.player2){const l=document.createElement('div');l.className='match-item';l.textContent=`${m.map} â€” ${m.player1} vs ${m.player2} | ìŠ¹ì: ${m.winner||'-'}${m.score?` | ${m.score}`:''}`;wrap.appendChild(l);}
      if(Array.isArray(m.team1)&&Array.isArray(m.team2)){const l=document.createElement('div');l.className='match-item';const win=Array.isArray(m.winner)?m.winner.join(', '):(m.winner||'-');l.textContent=`${m.map} â€” [${m.team1.join(', ')}] vs [${m.team2.join(', ')}] | ìŠ¹ì: ${win}${m.score?` | ${m.score}`:''}`;wrap.appendChild(l);}
    }

    renderChart(eloByDate);
  }

  function renderChart(eloByDate){
    const c=document.getElementById('elo-chart-container');
    c.innerHTML=`<div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;">
      <div><div style="font-size:13px;color:#aaa;margin-bottom:6px">ë¹„êµí•  í”Œë ˆì´ì–´ ì„ íƒ (Ctrl/âŒ˜ ë‹¤ì¤‘ ì„ íƒ)</div>
      <select id="eloPlayerSelect" multiple size="10" style="min-width:220px;height:200px;padding:10px;border-radius:8px;border:1px solid #2c2f3a;background:#101018;color:#fff;">
      ${Object.keys(eloByDate).sort().map(id=>`<option value="${id}">${id}</option>`).join('')}</select></div>
      <div id="eloChartArea" style="flex:1;min-width:320px;width:100%;height:460px"></div></div>`;
    const {LineChart,Line,XAxis,YAxis,CartesianGrid,Tooltip,Legend,ResponsiveContainer}=window.Recharts;
    const palette=["#ff6a00","#4ade80","#60a5fa","#f472b6","#facc15","#38bdf8","#a78bfa","#fb923c","#22d3ee","#94a3b8"];
    function draw(sel){const a=document.getElementById("eloChartArea");if(sel.length===0){a.innerHTML=`<div class="muted">ì™¼ìª½ì—ì„œ 1ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.</div>`;return;}
      const all=[...new Set(sel.flatMap(id=>Object.keys(eloByDate[id]||{})))].sort((a,b)=>{const [am,ad]=a.split('/').map(Number),[bm,bd]=b.split('/').map(Number);return am===bm?ad-bd:am-bm;});
      const rows=all.map(d=>{const r={date:d};sel.forEach(id=>r[id]=eloByDate[id]?.[d]??null);return r;});
      ReactDOM.render(React.createElement(ResponsiveContainer,{width:"100%",height:460},
        React.createElement(LineChart,{data:rows,margin:{top:20,right:30,left:0,bottom:0}},
          React.createElement(CartesianGrid,{strokeDasharray:"3 3",stroke:"rgba(255,255,255,0.12)"}),
          React.createElement(XAxis,{dataKey:"date",stroke:"#aaa",tick:{fontSize:12}}),
          React.createElement(YAxis,{stroke:"#aaa",domain:[800,1200],tick:{fontSize:12}}),
          React.createElement(Tooltip,{formatter:(v)=>Math.round(v),contentStyle:{backgroundColor:"#1a1a22",border:"1px solid #333"}}),
          React.createElement(Legend,null),
          ...sel.map((id,i)=>React.createElement(Line,{key:id,type:"monotone",dataKey:id,name:id,stroke:palette[i%palette.length],dot:false,strokeWidth:2,isAnimationActive:false}))
        )),a);}
    document.getElementById("eloPlayerSelect").addEventListener("change",e=>{const s=[...e.target.selectedOptions].map(o=>o.value);draw(s);});
  }

  start();
</script>
</body>
</html>
